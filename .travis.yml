language: java
jdk:
- oraclejdk8
sudo: required
services:
- docker

env:
  global:
  - secure: G+3YZ8/bGhgT/XbclAjIGM0dP9adiTcBAjKL/gKAOGqELyagi9YrPDjwwOmz50GmDt95ITpgEWjrSzEfthUoFuo6gqH2HQ0MJjgxoNGzFYOmFSD2zpYRtgPFpTWt1o185LwwxZJSzNEW8vLg1CQBzZXvfw8VxDstVcgMP5A6XKV1Xxz8+JcdKTWTQGcgl33c6upxdDh5cv2Bua4uebWzBSb9sMqegjXsRhKEXconuqa4b6LVpEu54SFR5DmyACL22LZ+C4874WCnHSZfiBcmlAWOTQJ1APpO01E1/xEnv9FEyfiDBrBeRnCpNlQm08XoGsfJ8X6EzUka1NsmmZ/CTDIvaQB6yMjymjltwmvoOyfRFlV+IhFyL2Fk4uh9GE58aroO4V/zfnOv7scoskL6RQoixy3gBVXdTqcUEzD64WIeHrInGO9MeymL8DSs2ST1Ycxb2GjbmzAwtyYevVpoJ2gD8HLXYoV6B+f0DKCeRpBwdmooAtWlWnKt0fKRdvTwv2I4zZDBdLxbLJdH3nR0JLfgY+psb0F6coS8QAU0xzdQmdWO1bpzQsDhFHR7wnt9/9q2VRHu6KcKYslEAXoGANDzLrhubdkdiPTzVSY2RB01etmLOyNKglpD8oXTymxsTjUWGcgvwTTKN1BsFnTon6/nFdFohfn5BWH+aJfsP24=

before_script:
# Install the Heroku CLI
- wget -qO- https://toolbelt.heroku.com/install.sh | sh
# Login to Docker Registries (Docker Hub and Heroku)
- echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
- echo "$HEROKU_PASSWORD" | docker login -u "$HEROKU_USERNAME" --password-stdin registry.heroku.com
# Change directories down into the releng package for the Maven build
- cd com.avojak.webapp.p2.inspector.releng

script:
- mvn clean verify coveralls:report &&
  cd .. &&
  docker build --tag avojak/p2-inspector:1.0.0-SNAPSHOT --tag avojak/p2-inspector:latest . &&
  docker tag avojak/p2-inspector:latest registry.heroku.com/p2-inspector/web

deploy:
  provider: script
  skip_cleanup: true
  script:
    # Push to Docker Hub and Heroku, then perform the Heroku release
    docker push avojak/p2-inspector:1.0.0-SNAPSHOT;
    docker push avojak/p2-inspector:latest;
    docker push registry.heroku.com/p2-inspector/web;
    heroku container:release web --app p2-inspector
  on:
    branch: master
